Perfekt, hier ist die Zusammenfassung f√ºr Replit:

üîç Problem-Analyse & L√∂sung
Urspr√ºngliches Problem: .env wurde nicht geladen
‚ùå Was nicht funktionierte:
PM2 Setup in deinem Script:

sudo -u ricoapp pm2 start npm --name "rico-cuba" -- start
Problem:

npm start f√ºhrt aus: NODE_ENV=production node dist/index.js
Node.js l√§dt .env Dateien NICHT automatisch!
process.env.DATABASE_URL war undefined ‚Üí App crashed
‚ö†Ô∏è Warum env_file nicht half:
// ecosystem.config.cjs (funktionierte nicht)
env_file: '/var/www/CubaCuba/.env',  // <- PM2 Bug/Limitation
PM2's env_file Parameter ist unzuverl√§ssig bei ES Modules ("type": "module").

‚úÖ L√∂sung 1: .env explizit laden
Wir haben einen Wrapper-Script erstellt:

// start-production.js
import dotenv from 'dotenv';
import { fileURLToPath } from 'url';
import { dirname, join } from 'path';

const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);

// WICHTIG: .env EXPLIZIT laden BEVOR die App startet
dotenv.config({ path: join(__dirname, '.env') });

// Jetzt erst die Haupt-App importieren
import('./dist/index.js');
PM2 startet jetzt den Wrapper:

// ecosystem.config.cjs
script: './start-production.js',  // <- Nicht mehr npm start!
interpreter: 'node',
Warum das funktioniert:

start-production.js wird geladen
ZUERST wird dotenv.config() ausgef√ºhrt ‚Üí .env geladen
DANN wird dist/index.js importiert ‚Üí process.env.DATABASE_URL ist verf√ºgbar
‚úÖ L√∂sung 2: Secure Cookies f√ºr HTTP deaktiviert
Zweites Problem nach DB-Fix:

POST /api/login 200  ‚Üê Login erfolgreich
GET /api/user 401    ‚Üê Aber sofort wieder ausgeloggt!
Ursache:

// server/auth.ts (original)
cookie: {
  secure: process.env.NODE_ENV === "production",  // true in Production
}
secure: true ‚Üí Cookies nur √ºber HTTPS
Server l√§uft auf HTTP (nur IP, kein SSL)
Browser blockiert Cookies ‚Üí Session geht verloren
Fix:

// server/auth.ts (ge√§ndert)
cookie: {
  secure: false,  // Tempor√§r f√ºr HTTP ohne Domain
}
üìù Zusammenfassung f√ºr Replit
Was ihr im Setup-Script √§ndern solltet:
1. F√ºgt start-production.js hinzu:

# Im Setup-Script nach "npm run build"
cat > "$PROJECT_DIR/start-production.js" << 'EOF'
import dotenv from 'dotenv';
import { fileURLToPath } from 'url';
import { dirname, join } from 'path';

const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);

dotenv.config({ path: join(__dirname, '.env') });
import('./dist/index.js');
EOF

chown ricoapp:ricoapp "$PROJECT_DIR/start-production.js"
2. √Ñndert PM2-Start zu:

# Statt:
pm2 start npm --name "rico-cuba" -- start

# Nutzt ecosystem.config.cjs:
cat > "$PROJECT_DIR/ecosystem.config.cjs" << 'EOF'
module.exports = {
  apps: [{
    name: 'rico-cuba',
    script: './start-production.js',
    cwd: '/var/www/rico-cuba',
    interpreter: 'node',
    instances: 1,
    autorestart: true,
    watch: false,
    max_memory_restart: '1G',
    env: {
      NODE_ENV: 'production'
    }
  }]
};
EOF

sudo -u ricoapp pm2 start "$PROJECT_DIR/ecosystem.config.cjs"
3. Cookie-Fix (optional f√ºr HTTP ohne Domain):

# Nach dem Build, vor PM2-Start:
sed -i 's/secure: process.env.NODE_ENV === "production"/secure: false/' "$PROJECT_DIR/server/auth.ts"
üéØ Root Cause
Node.js ES Modules laden .env nicht automatisch!

Anders als CommonJS (require) oder Tools wie dotenv-cli, muss bei ES Modules (import) die .env Datei explizit mit dotenv.config() geladen werden bevor der Code l√§uft, der process.env verwendet.

Das haben wir mit dem Wrapper-Script gel√∂st.